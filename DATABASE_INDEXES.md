# 数据库索引配置说明

为了支持用户注册的幂等判断功能，需要在云开发数据库中为 `users` 集合创建以下唯一索引：

## 必需的唯一索引

### 1. 用户名唯一索引
- **字段**: `username`
- **类型**: 唯一索引
- **说明**: 确保用户名唯一，防止重复注册

### 2. 邮箱唯一索引（可选但推荐）
- **字段**: `email`
- **类型**: 唯一索引（稀疏索引）
- **说明**: 确保邮箱唯一，允许空值

### 3. OpenID唯一索引（可选但推荐）
- **字段**: `openid`
- **类型**: 唯一索引（稀疏索引）
- **说明**: 确保微信OpenID唯一，允许空值

## 创建索引步骤

### 方法一：通过云开发控制台创建

1. 打开微信开发者工具
2. 点击顶部菜单栏的"云开发"
3. 进入"数据库"标签页
4. 选择 `users` 集合
5. 点击"索引管理"
6. 添加以下索引：

```json
{
  "username": 1
}
```

```json
{
  "email": 1
}
```

```json
{
  "openid": 1
}
```

### 方法二：通过命令行创建（如果支持）

```bash
# 创建用户名唯一索引
db.collection('users').createIndex({ username: 1 }, { unique: true })

# 创建邮箱唯一索引（稀疏索引，允许空值）
db.collection('users').createIndex({ email: 1 }, { unique: true, sparse: true })

# 创建OpenID唯一索引（稀疏索引，允许空值）
db.collection('users').createIndex({ openid: 1 }, { unique: true, sparse: true })
```

## 索引说明

- **唯一索引**: 确保字段值在集合中唯一
- **稀疏索引**: 只对包含该字段的文档创建索引，允许字段为空
- **复合索引**: 如果需要更复杂的唯一性约束，可以创建复合索引

## 错误处理

当尝试插入重复数据时，数据库会返回错误代码 `-502006`，注册云函数会捕获这个错误并返回"该账号已注册"的提示。

## 注意事项

1. 创建索引后，现有数据会进行验证，如果存在重复数据，索引创建会失败
2. 建议在应用上线前创建好所有必要的索引
3. 索引创建需要时间，请耐心等待完成

## 验证索引

创建索引后，可以通过以下方式验证：

1. 尝试注册相同用户名的用户，应该收到"该用户名已注册"的错误
2. 尝试注册相同邮箱的用户，应该收到"该邮箱已注册"的错误
3. 尝试用相同OpenID注册，应该收到"该微信账号已注册"的错误